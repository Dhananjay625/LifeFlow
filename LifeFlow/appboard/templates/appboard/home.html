{% extends 'appboard/base.html' %}
{% load static %}

{% block head_title %}Dashboard{% endblock %}

{% block extra_head %}
  <!-- Boxicons (for sidebar + dashboard icons) -->
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <!-- SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <style>
    /* ===== Dashboard Header ===== */
    .lf-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: .5rem 0 1rem;
    }
    .lf-header .date { font-size: .95rem; color: var(--text-muted); }
    .lf-header-right { display: flex; align-items: center; gap: .8rem; }
    #edit-dashboard-btn { min-height: 36px; padding: .5rem .9rem; }

    /* ===== Widget Library ===== */
    #widgetLibraryPanel {
      display: none;
      position: fixed;
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
      width: 240px;
      background: var(--background-light);
      padding: 1rem;
      border-radius: 1rem;
      border: 1px solid var(--panel-brd);
      box-shadow: 0 8px 16px rgba(0,0,0,.3);
      color: var(--text-light);
      z-index: 1000;
    }
    #widgetLibraryPanel h6 {
      margin: 0 0 .8rem;
      font-weight: 700;
      text-align: center;
      border-bottom: 1px solid var(--panel-brd);
      padding-bottom: .4rem;
    }
    .library-widget {
      background: #171717;
      border-left: 5px solid var(--accent-color);
      border-radius: 12px;
      padding: .8rem;
      margin-bottom: .8rem;
      cursor: grab;
      color: var(--text-light);
      font-weight: 600;
      transition: transform .12s, background .2s;
    }
    .library-widget:hover { transform: translateY(-2px); background: #1f1f1f; }

    /* ===== Dashboard grid ===== */
    #dashboard.row { min-height: 240px; }
    .sortable-ghost { opacity: .6; }

    /* ===== Cards ===== */
    .card {
      background: #1b1b1b;
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 14px;
    }
    .card-header {
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .delete-widget-btn { border: 1px solid var(--panel-brd); box-shadow: none; display: none; }

    @media (max-width: 720px) {
      .lf-header { flex-direction: column; gap: .5rem; align-items: flex-start; }
      .lf-header-right { width: 100%; justify-content: space-between; }
    }
  </style>
{% endblock %}

{% block content %}

<main class="content lf-wrap">
  <!-- Header row -->
  <div class="lf-header">
    <div class="date" id="today-date">â€”</div>
    <div class="lf-header-right">
      <h4>Dashboard</h4>
      <button id="edit-dashboard-btn" class="btn btn-primary btn-sm">Edit Dashboard</button>
    </div>
  </div>

  <!-- Widget library -->
<div id="widgetLibraryPanel">
  <h6>ğŸ“¦ Widget Library</h6>
  <div class="library-widget" draggable="true" data-widget-type="dashboard">ğŸ“Š Dashboard</div>
  <div class="library-widget" draggable="true" data-widget-type="kanban">ğŸ“Œ Kanban</div>
  <div class="library-widget" draggable="true" data-widget-type="calendar">ğŸ“… Calendar</div>
  <div class="library-widget" draggable="true" data-widget-type="document">ğŸ“ Document Manager</div>
  <div class="library-widget" draggable="true" data-widget-type="subscription">ğŸ“¬ Subscription Tracker</div>
  <div class="library-widget" draggable="true" data-widget-type="bills">ğŸ“„ Bill Manager</div>
  <div class="library-widget" draggable="true" data-widget-type="health">ğŸ’ª Health Manager</div>
  <div class="library-widget" draggable="true" data-widget-type="family">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Family</div>
</div>

  <!-- Dashboard grid -->
  <div id="dashboard" class="row g-3 sortable-container"></div>
</main>

<!-- Templates for all widgets -->
<template id="template-news">
  <div class="col-lg-6 col-md-8 col-sm-12 sortable-item my-3" data-id="news">
    <div class="card shadow h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">ğŸ—ï¸ Latest Mining News</h5>
        <button class="delete-widget-btn btn btn-ghost btn-sm">X</button>
      </div>
      <div class="card-body"><p class="text-muted">News goes hereâ€¦</p></div>
    </div>
  </div>
</template>

<template id="template-dashboard">
  <div class="col-lg-6 col-md-8 col-sm-12 sortable-item my-3" data-id="dashboard">
    <div class="card shadow h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">ğŸ“Š Dashboard</h5>
        <button class="delete-widget-btn btn btn-ghost btn-sm">X</button>
      </div>
      <div class="card-body"><p class="text-muted">Overview contentâ€¦</p></div>
    </div>
  </div>
</template>

<template id="template-kanban">
  <div class="col-lg-6 col-md-8 col-sm-12 sortable-item my-3" data-id="kanban">
    <div class="card shadow h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">ğŸ“Œ Kanban</h5>
        <button class="delete-widget-btn btn btn-ghost btn-sm">X</button>
      </div>
      <div class="card-body"><p class="text-muted">Tasks & projectsâ€¦</p></div>
    </div>
  </div>
</template>

<template id="template-calendar">
  <div class="col-lg-6 col-md-8 col-sm-12 sortable-item my-3" data-id="calendar">
    <div class="card shadow h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">ğŸ“… Calendar</h5>
        <button class="delete-widget-btn btn btn-ghost btn-sm">X</button>
      </div>
      <div class="card-body">
        <ul class="text-muted small mb-0"></ul> 
      </div>
    </div>
  </div>
</template>

<template id="template-document">
  <div class="col-lg-6 col-md-8 col-sm-12 sortable-item my-3" data-id="document">
    <div class="card shadow h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">ğŸ“ Document Manager</h5>
        <button class="delete-widget-btn btn btn-ghost btn-sm">X</button>
      </div>
      <div class="card-body"><ul class="text-muted small mb-0"></ul></div>
    </div>
  </div>
</template>

<template id="template-subscription">
  <div class="col-lg-6 col-md-8 col-sm-12 sortable-item my-3" data-id="subscription">
    <div class="card shadow h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">ğŸ“¬ Subscription Tracker</h5>
        <button class="delete-widget-btn btn btn-ghost btn-sm">X</button>
      </div>
      <div class="card-body"><ul class="text-muted small mb-0"></ul></div>
    </div>
  </div>
</template>

<template id="template-bills">
  <div class="col-lg-6 col-md-8 col-sm-12 sortable-item my-3" data-id="bills">
    <div class="card shadow h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">ğŸ“„ Bill Manager</h5>
        <button class="delete-widget-btn btn btn-ghost btn-sm">X</button>
      </div>
      <div class="card-body"><ul class="text-muted small mb-0"></ul></div>
    </div>
  </div>
</template>

<template id="template-health">
  <div class="col-lg-6 col-md-8 col-sm-12 sortable-item my-3" data-id="health">
    <div class="card shadow h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">ğŸ’ª Health Manager</h5>
        <button class="delete-widget-btn btn btn-ghost btn-sm">X</button>
      </div>
      <div class="card-body"><p class="text-muted">Loading health dataâ€¦</p></div>
    </div>
  </div>
</template>

<template id="template-family">
  <div class="col-lg-6 col-md-8 col-sm-12 sortable-item my-3" data-id="family">
    <div class="card shadow h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Family</h5>
        <button class="delete-widget-btn btn btn-ghost btn-sm">X</button>
        <button class="edit-widget-btn btn btn-ghost btn-sm">âœï¸</button>
      </div>
      <div class="card-body"><ul class="text-muted small mb-0"></ul></div>
    </div>
  </div>
</template>

<!-- Dashboard Script -->
<script>
document.addEventListener('DOMContentLoaded', function(){
  const dashboard = document.getElementById('dashboard');
  const editBtn   = document.getElementById('edit-dashboard-btn');
  const library   = document.getElementById('widgetLibraryPanel');

  const dateDiv = document.getElementById("today-date");
  const now = new Date();
  const options = { weekday: "short", month: "short", day: "numeric", year: "numeric" };
  if (dateDiv) {
    dateDiv.textContent = now.toLocaleDateString("en-AU", options);
  }
  

  let sortable = new Sortable(dashboard, {
    animation: 150,
    handle: '.card-header',
    filter: '.delete-widget-btn',
    preventOnFilter: false,
    disabled: true,
    onEnd: saveState
  });

  function createWidget(type){
    const tpl = document.getElementById(`template-${type}`);
    if (!tpl) return;
    const frag = tpl.content.cloneNode(true);
    dashboard.appendChild(frag);
    bindDelete();
    loadWidgetData(type);
    saveState();
  }

  function bindDelete(){
    dashboard.querySelectorAll('.delete-widget-btn').forEach(btn => {
      btn.onclick = e => {
        const item = e.target.closest('.sortable-item');
        if (item) item.remove();
        saveState();
      };
    });
  }

  function loadWidgetData(type) {
    const widget = dashboard.querySelector(`.sortable-item[data-id="${type}"]`);
    if (!widget) return;
    const body = widget.querySelector('.card-body');
    const url = `/api/widgets/${type}/`;
    console.log("ğŸš€ Widget loading triggered:", type);

    fetch(url)
      .then(res => res.json())
      .then(data => {
        if (type === "kanban") {
          body.innerHTML = `<p class="text-muted">Pending: ${data.summary.pending || 0}, Completed: ${data.summary.completed || 0}, Archived: ${data.summary.archived || 0}</p>`;
        } else if (type === "calendar") {
          const ul = body.querySelector('ul');
          ul.innerHTML = '';
          data.forEach(ev => {   // our Django view returns a plain list now
            const li = document.createElement('li');
            const creator = ev.created_by || 'Anonymous';   // new field we added
            const date = ev.start ? ev.start.split('T')[0] : 'No date';
            li.textContent = `${ev.title} (by ${creator}) on ${date}`;
            ul.appendChild(li);
          });
        } else if (type === "bills") {
          const ul = body.querySelector('ul');
          ul.innerHTML = '';
          data.bills.forEach(b => {
            const li = document.createElement('li');
            li.textContent = `${b.name} - $${b.cost} (due ${b.renewal})`;
            ul.appendChild(li);
          });
        } else if (type === "subscription") {
          const ul = body.querySelector('ul');
          ul.innerHTML = '';
          data.subscriptions.forEach(s => {
            const li = document.createElement('li');
            li.textContent = `${s.name} - $${s.cost} (renews ${s.renewal})`;
            ul.appendChild(li);
          });
        } else if (type === "document") {
          const ul = body.querySelector('ul');
          ul.innerHTML = '';
          data.documents.forEach(d => {
            const li = document.createElement('li');
            li.textContent = `${d.name} (uploaded ${d.uploaded})`;
            ul.appendChild(li);
          });
        } else if (type === "health") {
          if (data.metrics) {
            body.innerHTML = `<p class="text-muted">
              Date: ${data.metrics.date}<br>
              Water: ${data.metrics.water} L<br>
              Steps: ${data.metrics.steps}<br>
              Calories: ${data.metrics.calories}
            </p>`;
          } else {
            body.innerHTML = `<p class="text-muted">No health metrics found.</p>`;
          }
        } else if (type === "family") {
          const ul = body.querySelector('ul');
          ul.innerHTML = '';
          data.families.forEach(f => {
            const li = document.createElement('li');
            li.textContent = `${f.name} (role: ${f.role})`;
            ul.appendChild(li);
          });
        }
      })
      .catch(err => {
        console.error(`Widget ${type} error:`, err);
        body.innerHTML = `<p class="text-danger">Failed to load data.</p>`;
      });
  }

  function saveState(){
    const ids = Array.from(dashboard.querySelectorAll('.sortable-item')).map(i => i.dataset.id);
    localStorage.setItem('dashboardOrder', JSON.stringify(ids));
  }

  function loadState(){
    let ids = JSON.parse(localStorage.getItem('dashboardOrder') || '[]');
    if (ids.length === 0) {
      ids = ["calendar", "document", "subscription", "bills", "health", "family"];
    }
    dashboard.innerHTML = '';
    ids.forEach(id => createWidget(id));
  }

  editBtn.addEventListener('click', () => {
    const editing = sortable.option('disabled');
    sortable.option('disabled', !editing);
    library.style.display = editing ? 'block' : 'none';
    dashboard.querySelectorAll('.delete-widget-btn').forEach(btn => {
      btn.style.display = editing ? 'block' : 'none';
    });
    editBtn.textContent = editing ? 'Save Layout' : 'Edit Dashboard';
  });

  document.querySelectorAll('.library-widget').forEach(w => {
    w.addEventListener('dragstart', e => {
      e.dataTransfer.setData('widget-type', w.dataset.widgetType);
    });
  });

  dashboard.addEventListener('dragover', e => e.preventDefault());
  dashboard.addEventListener('drop', e => {
    e.preventDefault();
    const type = e.dataTransfer.getData('widget-type');
    if (type) createWidget(type);
  });

  loadState();
});
</script>

{% endblock %}