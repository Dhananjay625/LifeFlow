{% extends 'appboard/base.html' %}
{% load static %}

{% block head_title %}Dashboard{% endblock %}

{% block extra_head %}
  <!-- Boxicons (for sidebar + dashboard icons) -->
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <!-- SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <style>
    /* ===== Dashboard Header ===== */
    .lf-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: .5rem 0 1rem;
    }
    .lf-header .date { font-size: .95rem; color: var(--text-muted); }
    .lf-header-right { display: flex; align-items: center; gap: .8rem; }
    #edit-dashboard-btn { min-height: 36px; padding: .5rem .9rem; }

    /* ===== Widget Library ===== */
    #widgetLibraryPanel {
      display: none;
      position: fixed;
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
      width: 240px;
      background: var(--background-light);
      padding: 1rem;
      border-radius: 1rem;
      border: 1px solid var(--panel-brd);
      box-shadow: 0 8px 16px rgba(0,0,0,.3);
      color: var(--text-light);
      z-index: 1000;
    }
    #widgetLibraryPanel h6 {
      margin: 0 0 .8rem;
      font-weight: 700;
      text-align: center;
      border-bottom: 1px solid var(--panel-brd);
      padding-bottom: .4rem;
    }
    .library-widget {
      background: #171717;
      border-left: 5px solid var(--accent-color);
      border-radius: 12px;
      padding: .8rem;
      margin-bottom: .8rem;
      cursor: grab;
      color: var(--text-light);
      font-weight: 600;
      transition: transform .12s, background .2s;
    }
    .library-widget:hover { transform: translateY(-2px); background: #1f1f1f; }

    /* ===== Dashboard grid ===== */
    #dashboard.row { min-height: 240px; }
    .sortable-ghost { opacity: .6; }

    /* ===== Cards ===== */
    .card {
      background: #1b1b1b;
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 14px;
    }
    .card-header {
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .delete-widget-btn { border: 1px solid var(--panel-brd); box-shadow: none; display: none; }

    @media (max-width: 720px) {
      .lf-header { flex-direction: column; gap: .5rem; align-items: flex-start; }
      .lf-header-right { width: 100%; justify-content: space-between; }
    }
  </style>
{% endblock %}

{% block content %}

<main class="content lf-wrap">
  <!-- Header row -->
  <div class="lf-header">
    <div class="date" id="today-date">â€”</div>
    <div class="lf-header-right">
      <h4>Dashboard</h4>
      <button id="edit-dashboard-btn" class="btn btn-primary btn-sm">Edit Dashboard</button>
    </div>
  </div>

  <!-- Widget library -->
  <div id="widgetLibraryPanel">
    <h6>ğŸ“¦ Widget Library</h6>
    <div class="library-widget" draggable="true" data-widget-type="news">ğŸ—ï¸ Mining News</div>
    <div class="library-widget" draggable="true" data-widget-type="gis">ğŸ—ºï¸ GIS Plotter</div>
    <div class="library-widget" draggable="true" data-widget-type="apps">ğŸ“± My Apps</div>
    <div class="library-widget" draggable="true" data-widget-type="calendar">ğŸ“… Calendar</div>
    <div class="library-widget" draggable="true" data-widget-type="todo">ğŸ“‹ To-Do List</div>
    <div class="library-widget" draggable="true" data-widget-type="disaster-alerts">âš ï¸ Disaster Alerts</div>
    <div class="library-widget" draggable="true" data-widget-type="reminder">â° Reminder</div>
  </div>

  <!-- Dashboard grid -->
  <div id="dashboard" class="row g-3 sortable-container"></div>
</main>

<!-- Example template: News -->
<template id="template-news">
  <div class="col-lg-6 col-md-8 col-sm-12 sortable-item my-3" data-id="news">
    <div class="card shadow h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">ğŸ—ï¸ Latest Mining News</h5>
        <button class="delete-widget-btn btn btn-ghost btn-sm">X</button>
      </div>
      <div class="card-body">
        <p class="text-muted">News goes hereâ€¦</p>
      </div>
    </div>
  </div>
</template>

<!-- Add more widget templates as needed -->

<script>
  document.addEventListener('DOMContentLoaded', function(){
    // Date
    const d = new Date();
    document.getElementById('today-date').textContent = d.toLocaleDateString(
      undefined, { weekday:'long', year:'numeric', month:'long', day:'numeric' }
    );

    // Dashboard state
    const dashboard = document.getElementById('dashboard');
    const editBtn   = document.getElementById('edit-dashboard-btn');
    const library   = document.getElementById('widgetLibraryPanel');

    let sortable = new Sortable(dashboard, {
      animation: 150, handle: '.card-header', filter: '.delete-widget-btn',
      preventOnFilter: false, disabled: true, onEnd: saveState
    });

    function createWidget(type){
      const tpl = document.getElementById(`template-${type}`);
      if (!tpl) return;
      const frag = tpl.content.cloneNode(true);
      dashboard.appendChild(frag);
      bindDelete();
      saveState();
    }

    function bindDelete(){
      dashboard.querySelectorAll('.delete-widget-btn').forEach(btn=>{
        btn.onclick = e=>{
          const item = e.target.closest('.sortable-item');
          if (item) item.remove();
          saveState();
        };
      });
    }

    function saveState(){
      const ids = Array.from(dashboard.querySelectorAll('.sortable-item')).map(i=>i.dataset.id);
      localStorage.setItem('dashboardOrder', JSON.stringify(ids));
    }

    function loadState(){
      const ids = JSON.parse(localStorage.getItem('dashboardOrder')||'[]');
      dashboard.innerHTML = '';
      ids.forEach(id=> createWidget(id));
    }

    editBtn.addEventListener('click', ()=>{
      const editing = sortable.option('disabled');
      sortable.option('disabled', !editing);
      library.style.display = editing ? 'block' : 'none';
      dashboard.querySelectorAll('.delete-widget-btn').forEach(btn=>{
        btn.style.display = editing ? 'block' : 'none';
      });
      editBtn.textContent = editing ? 'Save Layout' : 'Edit Dashboard';
    });

    // Drag from library
    document.querySelectorAll('.library-widget').forEach(w=>{
      w.addEventListener('dragstart', e=>{
        e.dataTransfer.setData('widget-type', w.dataset.widgetType);
      });
    });
    dashboard.addEventListener('dragover', e=> e.preventDefault());
    dashboard.addEventListener('drop', e=>{
      e.preventDefault();
      const type = e.dataTransfer.getData('widget-type');
      if (type) createWidget(type);
    });

    loadState();
  });
</script>

{% endblock %}
