{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Family - LifeFlow</title>
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'index.css' %}?v=51">

  <!-- Leaflet CSS (for map) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    /* Map modal styles */
    .map-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9999}
    .map-wrap{position:absolute;inset:5%;background:#111;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.4);display:flex;flex-direction:column}
    .map-head{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid rgba(255,255,255,.08)}
    .map-head h3{margin:0;font-size:1rem}
    .map-close{background:transparent;border:0;color:#fff;font-size:1.1rem;cursor:pointer}
    #mapContainer{flex:1;min-height:320px}
  </style>
</head>

<body>
  <div class="container">
    <!-- Sidebar -->
    <aside>
      <nav class="nav">
        <ul class="nav-links">
          <li>
            <a href="{% url 'UserProfile' %}" {% if request.resolver_match.url_name == 'TaskManager' %}{% endif %}>
              <i class='bx bx bx-user'></i><span><strong>{{ user.username }}</strong></span>
            </a>
          </li>
          <li>
            <a href="{% url 'appboard:home' %}"
               class="{% if request.resolver_match.namespace == 'appboard' %}active{% endif %}">
              <i class='bx bx-grid-alt'></i><span>Dashboard</span>
            </a>
          </li>
          <li>
            <a href="{% url 'kanban:kanban' %}" class="{% if request.resolver_match.url_name == 'kanban' %}active{% endif %}">
              <i class='bx bx-columns'></i><span>Kanban</span>
            </a>
          </li>
          <li>
            <a href="{% url 'calendar' %}" {% if request.resolver_match.url_name == 'calendar' %}class="active"{% endif %}>
              <i class='bx bx-calendar'></i><span>Calendar</span>
            </a>
          </li>
          <li>
            <a href="{% url 'confirm_password' %}" {% if request.resolver_match.url_name == 'DocumentStorage' %}class="active"{% endif %}>
              <i class='bx bx-folder'></i><span>Document Manager</span>
            </a>
          </li>
          <li>
            <a href="{% url 'Subscription' %}" {% if request.resolver_match.url_name == 'Subscription' %}class="active"{% endif %}>
              <i class='bx bx-cloud-download'></i><span>Subscription Tracker</span>
            </a>
          </li>
          <li>
            <a href="{% url 'BillManager' %}" {% if request.resolver_match.url_name == 'BillManager' %}class="active"{% endif %}>
              <i class='bx bx-receipt'></i><span>Bill Manager</span>
            </a>
          </li>
          <li>
            <a href="{% url 'HealthManager' %}" {% if request.resolver_match.url_name == 'HealthManager' %}class="active"{% endif %}>
              <i class='bx bx-dumbbell'></i><span>Health Manager</span>
            </a>
          </li>
          <li><a href="{% url 'FamilyManager' %}" {% if request.resolver_match.url_name == 'FamilyManager' %}class="active"{% endif %}>
          <i class='bx bx-group'></i><span>Family</span></a></li>
          <li><a href="#"><i class='bx bx-group'></i><span>Family</span></a></li>
          <li>
            <a href="http://127.0.0.1:8000" target="_blank">
              <i class='bx bx-map'></i><span>GeoDesk</span>
            </a>
          </li>
          <li>
            <a href="{% url 'kanban:projectsKanban' %}"
               class="{% if request.resolver_match.url_name == 'projectsKanban' %}active{% endif %}">
               <i class='bx bx-briefcase'></i><span>Projects</span>
            </a>
          </li>
        </ul>
        
        <div class="collapse-btn">
          <a href="#" data-resize-btn>
            <i class='bx bx-chevrons-right'></i><span>Collapse</span>
          </a>
        </div>
        <div class="logout-btn">
          <a href="{% url 'login' %}">
            <i class='bx bx-log-out'></i><span>Logout</span>
          </a>
        </div>
      </nav>
    </aside>

    <!-- Main -->
    <main class="content">
      <header class="header">
        <div class="date">{% now "l, F j, Y" %}</div>
        <h1>Family</h1>
      </header>

      <!-- Flash messages -->
      {% if messages %}
      <ul class="messages" style="margin:.5rem 0 1rem; padding:0; list-style:none;">
        {% for message in messages %}
          <li class="message {{ message.tags }}" style="padding:.6rem .8rem; border-radius:.5rem; background:rgba(255,255,255,.05); margin:.4rem 0;">
            {{ message }}
          </li>
        {% endfor %}
      </ul>
      {% endif %}

      <!-- Top row -->
      {% if has_family %}
      <section class="cards-grid family-grid">
        <!-- Family Summary -->
        <div class="card">
          <div class="card-header">
            <h2>{{ family.name|default:"—" }}</h2>
            <p class="card-sub">Share tasks, bills, and calendar events together.</p>
          </div>

          <div class="stats">
            <div class="stat">
              <span class="stat-label">Owner</span>
              <span class="stat-value">{{ owner.username|default:user.username }}</span>
            </div>
            <div class="stat">
              <span class="stat-label">Members</span>
              <span class="stat-value">{{ members|length }}</span>
            </div>
            <div class="stat">
              <span class="stat-label">Active Since</span>
              <span class="stat-value">{{ family.created_at|date:"M j, Y"|default:"—" }}</span>
            </div>
          </div>

          <!-- Primary: Invite (visible to all, only owners can open) -->
          <div class="card-actions">
            <a class="btn btn-primary btn-lg" href="#" id="openInviteModal">
              <i class='bx bx-user-plus' style="font-size:1.2rem;vertical-align:-2px"></i>
              Invite Member
            </a>
          </div>

          {% if is_owner %}
            <!-- Owners: no leave button here -->
          {% else %}
            <!-- Non-owners: Leave button (first card) -->
            <form method="post" action="{% url 'family_leave' %}" style="margin:0;">
              {% csrf_token %}
              <input type="hidden" name="family_id" value="{{ family.id }}">
              <button class="option-btn" type="submit" id="btnLeaveFamily">
                <i class='bx bx-log-out-circle'></i>
                Leave Family
              </button>
            </form>
          {% endif %}
        </div>

        <!-- Create / Delete -->
        <div class="card">
          <div class="card-header">
            <h2>{% if is_owner %}Create Another Family{% else %}Create Family{% endif %}</h2>
          </div>

          <form method="post" action="{% url 'family_create' %}">
            {% csrf_token %}
            <div class="form-group">
              <label for="fam_name">Family Name</label>
              <input id="fam_name" name="name" type="text" placeholder="e.g. The Rai Family">
            </div>
            <div class="form-actions">
              <button class="btn btn-primary btn-lg btn-block" type="submit">Create</button>
            </div>
          </form>

          <!-- Delete family -->
          <form id="deleteFamilyForm" method="post" action="{% url 'family_delete' %}" style="margin-top:0.8rem;">
            {% csrf_token %}
            <input type="hidden" name="family_id" value="{{ family.id }}">
            <button class="option-btn" type="submit">
              <i class='bx bx-trash'></i>
              Delete Family
            </button>
          </form>
        </div>
      </section>
      {% else %}
      <!-- Empty state -->
      <section class="empty-family">
        <div class="card empty-card">
          <div class="card-header">
            <h2>Create Family</h2>
            <p class="card-sub">Start a shared space for tasks, bills, and events.</p>
          </div>

          <form method="post" action="{% url 'family_create' %}">
            {% csrf_token %}
            <div class="form-group">
              <label for="fam_name">Family Name</label>
              <input id="fam_name" name="name" type="text" placeholder="e.g. The Rai Family">
            </div>
            <div class="form-actions">
              <button class="btn btn-primary btn-lg btn-block" type="submit">Create</button>
            </div>
          </form>
        </div>
      </section>
      {% endif %}

      {% if has_family %}
      <!-- Members -->
      <section class="members-section">
        <h2 class="title">Members</h2>
        <ul class="task-list" id="membersList">
          {% for m in members %}
          <li class="task-item">
            <span class="status-dot" style="background:#4ECDC4"></span>

            <label style="flex:1;font-size:18px;">
              {{ m.user.get_full_name|default:m.user.username }}
              <span class="date"> • {{ m.role|title }}</span>
            </label>

            <!-- Live location -->
            <button class="icon-btn location-btn" title="Show live location"
                    data-member-id="{{ m.id }}"
                    data-member-name="{{ m.user.get_full_name|default:m.user.username }}">
              <i class='bx bx-map-pin'></i>
            </button>

            <!-- Assign task -->
            <button class="icon-btn assign-btn" title="Assign task"
                    data-member-id="{{ m.id }}"
                    data-member-name="{{ m.user.get_full_name|default:m.user.username }}">
              <i class='bx bx-plus'></i>
            </button>

            <!-- Remove (placeholder) -->
            <button class="delete-btn" title="Remove" onclick="toast('Remove: hook backend next')">
              <i class='bx bx-user-x'></i>
            </button>
          </li>
          {% empty %}
          <li class="task-item"><label>No members yet. Use “Invite Member”.</label></li>
          {% endfor %}
        </ul>
      </section>

      <!-- Recent Tasks -->
      <section style="margin-top:1.2rem;margin-bottom:2rem;">
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <h2 class="title">Recent Tasks</h2>
        </div>
        <ul class="task-list" id="recentTasks">
          {% for t in tasks %}
          <li class="task-item">
            <input type="checkbox" {% if t.status == 'completed' %}checked{% endif %} disabled />
            <label style="flex:1">
              {{ t.title }}
              {% if t.due_date %}<span class="date"> • Due: {{ t.due_date|date:"M j, g:i a" }}</span>{% endif %}
              {% if t.assigned_to %}<span class="date"> • → {{ t.assigned_to.username|default:t.assigned_to }}</span>{% endif %}
              {% if t.priority %}<span class="date"> • {{ t.priority|title }}</span>{% endif %}
            </label>
          </li>
          {% empty %}
          <li class="task-item" data-empty="1"><label>No tasks yet.</label></li>
          {% endfor %}
        </ul>
      </section>
      {% endif %}
    </main>
  </div>

  {% if has_family %}
  <!-- Invite Modal -->
  <div id="inviteModal" class="modal">
    <div class="modal-content">
      <h2 style="margin-top:0;color:var(--primary-color);">Invite Member</h2>
      <form method="post" action="{% url 'family_invite_create' %}">
        {% csrf_token %}
        <div class="form-group">
          <label for="invite_email">Email</label>
          <input id="invite_email" type="email" name="email" placeholder="person@example.com" required />
        </div>
        <div class="form-group">
          <label for="invite_role">Role</label>
          <select id="invite_role" name="role">
            <option value="parent">Parent</option>
            <option value="child">Child</option>
          </select>
        </div>
        <div class="modal-buttons">
          <button type="button" id="cancelInvite" class="btn btn-ghost">Cancel</button>
          <button type="submit" class="btn btn-primary btn-block">Send Invite</button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}

  <!-- existing scripts -->
  <script>
    // sidebar collapse
    const resizeBtn = document.querySelector("[data-resize-btn]");
    resizeBtn?.addEventListener("click", (e) => {
      e.preventDefault();
      document.body.classList.toggle("sb-expanded");
    });

    // toast
    window.toast = (msg) => alert(msg);

    // CSRF helper
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    const CSRF = getCookie('csrftoken');

    // Server flags
    const CAN_INVITE = {{ is_owner|yesno:"true,false" }};   // owner can invite
    const HAS_FAMILY = {{ has_family|yesno:"true,false" }};
    const IS_OWNER   = {{ is_owner|yesno:"true,false" }};

    // Invite modal gating
    const modal     = document.getElementById('inviteModal');
    const openBtn   = document.getElementById('openInviteModal');
    const cancelBtn = document.getElementById('cancelInvite');

    openBtn?.addEventListener('click', (e) => {
      e.preventDefault();
      if (!HAS_FAMILY) { toast('Create or join a family first.'); return; }
      if (!CAN_INVITE) { toast('Only the family owner can send invites.'); return; }
      modal.style.display = 'block';
    });
    cancelBtn?.addEventListener('click', () => modal.style.display='none');
    window.addEventListener('click', (e) => { if (e.target === modal) modal.style.display='none'; });

    // Delete family (form submit; guard for non-owners)
    const deleteForm = document.getElementById('deleteFamilyForm');
    deleteForm?.addEventListener('submit', (e) => {
      if (!HAS_FAMILY) { e.preventDefault(); toast('No family to delete.'); return; }
      if (!IS_OWNER)   { e.preventDefault(); toast('Only the owner can delete this family.'); return; }
      if (!confirm('Delete this family? This cannot be undone.')) e.preventDefault();
    });

    // Assign task (existing)
    const membersList = document.getElementById('membersList');
    membersList?.addEventListener('click', async (e) => {
      const assignBtn = e.target.closest('.assign-btn');
      if (!assignBtn) return;

      const memberId = assignBtn.getAttribute('data-member-id');
      const name = assignBtn.getAttribute('data-member-name') || 'Member';

      const title = prompt(`Assign a task to ${name}:`, '');
      if (!title) return;

      let due = prompt('Optional due date (YYYY-MM-DD or YYYY-MM-DDTHH:MM):', '');
      due = (due || '').trim();

      try {
        const resp = await fetch("{% url 'family_task_assign' %}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF },
          body: JSON.stringify({ member_id: memberId, title, due_date: due })
        });
        if (!resp.ok) {
          const txt = await resp.text();
          toast(txt || 'Failed to assign task.');
          return;
        }
        const data = await resp.json();
        // Update Recent Tasks
        const ul = document.getElementById('recentTasks');
        if (!ul) return;
        const emptyRow = ul.querySelector('[data-empty="1"]'); if (emptyRow) emptyRow.remove();
        const li = `
          <li class="task-item">
            <input type="checkbox" disabled />
            <label style="flex:1">
              ${data.title.replace(/</g,'&lt;')}
              ${data.due_date_html || ''}
              <span class="date"> • → ${data.assigned_to || ''}</span>
              ${data.priority_html || ''}
            </label>
          </li>`;
        ul.insertAdjacentHTML('afterbegin', li);
      } catch (err) {
        toast('Network error.');
      }
    });
  </script>

  <!-- Leaflet JS (for map) -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Map modal markup -->
  <div id="mapModal" class="map-modal" aria-modal="true" role="dialog">
    <div class="map-wrap">
      <div class="map-head">
        <h3 id="mapTitle">Location</h3>
        <button class="map-close" id="mapClose" title="Close">✕</button>
      </div>
      <div id="mapContainer"></div>
    </div>
  </div>

  <!-- Map logic + hook into location button -->
  <script>
    const mapModal = document.getElementById('mapModal');
    const mapClose = document.getElementById('mapClose');
    const mapTitle = document.getElementById('mapTitle');
    let MAP = null, MARKER = null, ACCURACY = null;

    function openMapModal(){ mapModal.style.display='block'; setTimeout(()=> MAP && MAP.invalidateSize(), 50); }
    function closeMapModal(){ mapModal.style.display='none'; }
    mapClose?.addEventListener('click', closeMapModal);
    mapModal?.addEventListener('click', (e)=>{ if(e.target === mapModal) closeMapModal(); });

    function showMap(lat, lng, accMeters, name){
      mapTitle.textContent = `${name} — ${lat.toFixed(5)}, ${lng.toFixed(5)} (±${Math.round(accMeters||0)}m)`;
      if(!MAP){
        MAP = L.map('mapContainer');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap'
        }).addTo(MAP);
      }
      MAP.setView([lat, lng], 15);
      if(!MARKER){ MARKER = L.marker([lat,lng]).addTo(MAP); } else { MARKER.setLatLng([lat,lng]); }
      if(ACCURACY){ MAP.removeLayer(ACCURACY); }
      if(accMeters){ ACCURACY = L.circle([lat,lng], { radius: accMeters }).addTo(MAP); }
      openMapModal();
    }

    // hook: location buttons -> geolocation -> map
    membersList?.addEventListener('click', (e) => {
      const locBtn = e.target.closest('.location-btn');
      if(!locBtn) return;

      const name = locBtn.getAttribute('data-member-name') || 'Member';

      if (!('geolocation' in navigator)) {
        toast('Geolocation not supported in this browser.');
        return;
      }
      locBtn.classList.add('loc-pulse');
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          locBtn.classList.remove('loc-pulse');
          const { latitude, longitude, accuracy } = pos.coords;
          showMap(latitude, longitude, accuracy || 0, name);
        },
        (err) => {
          locBtn.classList.remove('loc-pulse');
          const msg = err.code === 1 ? 'Location permission denied.' :
                      err.code === 2 ? 'Position unavailable.' :
                      'Location request timed out.';
          toast(msg);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    });
  </script>
</body>
</html>
