{% extends "appboard/base.html" %}
{% load static %}

{% block head_title %}Store{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'store/store.css' %}">
{% endblock %}

{% block content %}
<div class="store-page">
  <div class="container-fluid">
    <div class="row gy-4">

      <!-- ================= LEFT FILTERS ================= -->
      <div class="col-lg-3 col-xl-3">
        <div class="card filter-card" style="height:95vh; overflow-y:auto;">

          <div class="card-body">
            <h2 class="panel-title">Find Products</h2>

            <form method="GET" action="" class="mb-4">
              <label class="form-label small mb-2">Sort by</label>
              <select id="sort" name="sort" class="form-select"
                      hx-get="{% url 'store:store' %}"
                      hx-target="#product-list" hx-push-url="true" hx-params="*"
                      onChange="this.form.submit();">
                <option value="popular"{% if sort_order == "popular" %} selected{% endif %}>Popularity</option>
                <option value="asc"{% if sort_order == "asc" %} selected{% endif %}>Least Expensive</option>
                <option value="desc"{% if sort_order == "desc" %} selected{% endif %}>Most Expensive</option>
              </select>
            </form>

            <form id="filter-form" hx-get="{% url 'store:store' %}" hx-target="#product-list" hx-push-url="true">
              <input type="hidden" name="sort" value="{{ sort_order }}">

              <div class="mb-3">
                <label class="form-label">Name</label>
                <input type="text" class="form-control" name="product-name"
                       placeholder="Search name…" value="{% if search_query %}{{ search_query }}{% endif %}">
              </div>

              <div class="mb-3">
                <label class="form-label">Price Range</label>
                <div class="row g-2">
                  <div class="col-6">
                    <input type="number" name="min-price" class="form-control" placeholder="Min" value="{{ min_price }}">
                  </div>
                  <div class="col-6">
                    <input type="number" name="max-price" class="form-control" placeholder="Max" value="{{ max_price }}">
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Tags</label>
                <div class="d-flex flex-wrap gap-2">
                  {% for tag in tags %}
                    <button type="button"
                            class="btn btn-sm {% if tag.id|stringformat:'s' in selected_tags %}btn-primary{% else %}btn-ghost{% endif %}"
                            data-tag-id="{{ tag.id }}"
                            onclick="toggleTag(this)">
                      {{ tag.name }}
                    </button>
                  {% endfor %}
                </div>
                <input type="hidden" name="tags" id="selected-tags" value="{{ selected_tags|join:',' }}">
              </div>

              <div class="d-grid gap-2 mt-3">
                <button type="submit" class="btn btn-primary">Apply Filter</button>
                <button type="button" class="btn btn-primary" onclick="clearFilter()">Clear Filter</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- ================= CENTER PRODUCTS ================= -->
      <div class="col-lg-6 col-xl-6 main-scroll" id="product-list">
        <div class="row">
          {% if products %}
          <div class="product-deck" style="display:flex; flex-wrap:wrap; gap:1rem;">

              {% for product in products %}
              <article class="card product-card" style="width: 19rem; min-width: 19rem; flex: 0 0 18rem;">

                  {% if product.thumbnail %}
                    <img src="{{ product.thumbnail.url }}" class="card-img-top" alt="{{ product.name }}">
                  {% else %}
                    <img src="{% static 'store/images/placeholder.png' %}" class="card-img-top" alt="Placeholder">
                  {% endif %}

                  <div class="card-body d-flex flex-column">
                    <h3 class="product-title">{{ product.name }}</h3>
                    <p class="product-desc text-muted">{{ product.description }}</p>

                    <div class="mt-auto">
                      <form method="POST" action="{% url 'store:update_cart' %}" data-ajax="add-to-cart">
                        {% csrf_token %}
                        <input type="hidden" name="product_id" value="{{ product.id }}">
                        <input type="hidden" name="action" value="add">

                        <div class="price-row">
                          <span class="price">${{ product.amount_dollars }}</span>
                        </div>

                        <div class="input-group add-row">
                          <input type="number" name="quantity" class="form-control qty-input" value="1" min="1">
                          <button type="submit" class="btn btn-primary flex-grow-1">Add to Cart</button>
                        </div>
                      </form>

                    
                    </div>
                  </div>
                </article>
              {% endfor %}
            </div>
          {% else %}
            <div class="empty-state">
              <p class="text-muted">No products matched your filters.</p>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- ================= RIGHT FIXED CART ================= -->
      <div class="col-lg-3 col-xl-3">
        <div class="card cart-card fixed-cart" style="height:95vh; overflow-y:auto;">

          <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-bold">Shopping Cart</span>
            
            <a href="{% url 'store:order_history' %}" class="btn btn-primary">Order History</a>
          </div>
          <div id="cart-empty-text" class="text-center text-muted small py-2" hidden>
            Your cart is empty.
          </div>
          <div class="card-body d-flex flex-column p-0">
            <div id="shopping-cart-container" class="p-2">
              {% include "store/cart_small.html" with shopping_cart=shopping_cart %}
            </div>

            <div class="cart-footer mt-auto p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <strong id="cart-subtotal"></strong>
              </div>
              <div id="cart-buttons" class="d-grid gap-2" hidden>
               
                <a href="{% url 'store:checkout' %}" class="btn btn-primary">Checkout</a>
              </div>
              
            </div>
          </div>
        </div>
      </div>

    </div><!-- /.row -->
  </div><!-- /.container-fluid -->
</div>

<script>
  /** Requires jQuery. Make sure jquery.js is loaded before this script. **/
  (function () {
    // Add-to-cart via AJAX (intercepts the form submit)
    $(document).on('submit', 'form[data-ajax="add-to-cart"]', function (e) {
      e.preventDefault();
  
      const $form = $(this);
      const csrf = $form.find('input[name="csrfmiddlewaretoken"]').val();
  
      $.ajax({
        url: $form.attr('action'),
        type: 'POST',
        dataType: 'json',
        headers: { 'X-CSRFToken': csrf },
        data: $form.serialize(),
        success: function (data) {
          // Expecting { id: "<product_id>", html: "<tr>…</tr>" }
          const $cartItems = $('#shopping-cart-items');
          const productId = data.id;
          const $incoming = $(data.html);
          let $row = $cartItems.find("tr[id='" + productId + "']");
  
          if ($row.length === 0) {
            // new line item
            $cartItems.append($incoming);
            $('#shopping-cart').prop('hidden', false);
            $('#cart-buttons').prop('hidden', false);
            $('#cart-empty-text').prop('hidden', true);
          } else {
            // update price/qty cells
            $row.find('td[data-type="price"]').text($incoming.find('td[data-type="price"]').text());
            $row.find('td[data-type="quantity"]').text($incoming.find('td[data-type="quantity"]').text());
          }
        },
        error: function (xhr) {
          console.error('Add to cart failed', xhr.responseText || xhr.statusText);
        }
      });
  
      return false; // extra safety to stop navigation
    });
  
    // Cart +/-/delete buttons (event delegation inside the cart)
    $('#shopping-cart').on('click', 'button[data-action]', function () {
      const $btn = $(this);
      const action = $btn.data('action');
      const $row = $btn.closest('tr');
      const productId = $row.attr('id');
  
      $.ajax({
        url: "{% url 'store:update_cart' %}",
        type: 'POST',
        dataType: 'json',
        headers: { 'X-CSRFToken': "{{ csrf_token }}" },
        data: { product_id: productId, action: action },
        success: function (data) {
          const $incoming = $(data.html || '');
          if ($incoming.length) {
            $row.find('td[data-type="price"]').text($incoming.find('td[data-type="price"]').text());
            $row.find('td[data-type="quantity"]').text($incoming.find('td[data-type="quantity"]').text());
          } else {
            // item removed
            $row.remove();
          }
  
          // Toggle empty/cart buttons
          if ($('#shopping-cart-items').children().length === 0) {
            $('#shopping-cart').prop('hidden', true);
            $('#cart-empty-text').prop('hidden', false);
            $('#cart-buttons').prop('hidden', true);
          } else {
            $('#shopping-cart').prop('hidden', false);
            $('#cart-empty-text').prop('hidden', true);
            $('#cart-buttons').prop('hidden', false);
          }
        },
        error: function (xhr) {
          console.error('Cart update failed', xhr.responseText || xhr.statusText);
        }
      });
    });
  })();
  </script>
  
{% endblock %}
